# Santa Clara University - CSEN268 Fall 2024

[Table of Contents](/toc.md)


## Lecture 14 - FutureBuilder, StreamBuilder, Shimmer + Firestore Operations
In this lecture we will look at asynchronous data and methods to display them in the UI. 

### Step 4 - Firestore
Here are some steps to expose the API for the Firestore NoSQL database.

#### Entering a Document
We can add a document where the `id` will be auto-generated by Firestore:
```dart
  void addUsers() async {
    List<Future> futs = [];
    for (User user in users) {
      futs.add(FirebaseFirestore.instance
          .collection('users_test')
          .add(user.toMap()));
    }
    await Future.wait(futs);
    ...
  }
```
Here the `FirebaseFirestore.instance.collection(<Collection>).add(<DataMap>)` method returns the `id` of the document.

#### Reading a Document from Firestore
Getting documents we can read a document by:
```dart
  void getUsersFirstNameStartsA_K() async {
    QuerySnapshot querySnapshot = await FirebaseFirestore.instance
        .collection('users_test')
        .where("firstName", isLessThan: "L")
        .get();
    usersAK = (qs.docs.length);
    setState(() {});
  }
```
Here we also employed a filter to select all first names that begin with letter A to K. 

This brings us a `QuerySnapshot` object with multiple docs. Then we could access the data by:
```dart
  forEach (doc in querySnapshot.docs){ 
    Map<String,dynamic> data = doc.data();
  }
```
#### Compound Queries
If we attempt a compound query such as:
```dart
  void getUsersFirstNameStartsA_K_and_LastNameL_Z() async {
    QuerySnapshot querySnapshot = await FirebaseFirestore.instance
        .collection('users_test')
        .where("firstName", isLessThan: "L")
        .where("lastName", isGreaterThan: "K")
        .get();
    ...
  }
```
then we will get an error:
```console
[ERROR:flutter/runtime/dart_vm_initializer.cc(41)] 
Unhandled Exception: [cloud_firestore/failed-precondition] 
The query requires an index. 

You can create it here: https://console.firebase.google.com/v1/r/project/
fir-messaging-8b691/firestore/indexes?create_composite=ClZ...QAQ .
The query contains range and inequality filters on multiple fields, 
please refer to the documentation for index selection best 
practices: https://cloud.google.com/firestore/docs/query-data/multiple-range-fields.
```
To sort it out you can click on the link and it will automatically take you to the indexing page in Firestore.

![Indexing Page](/assets/images/IndexingPage.png)

and you can see existing indicies (or ones being built) here:

![Indexing Page](/assets/images/IndexingPageBuilding.png)

#### DateTime in Firestore
Firestore stores DateTime objects in a slightly peculiar way and it's not `milliSecondsSinceEpoch`. Therefore care has to be taken in converting data from Firestore and to Firestore Map format. The standard method for a data class with a text and date field would be:
```dart
Map<String, dynamic> toMap() {
    return <String, dynamic>{
      'date': date.millisecondsSinceEpoch,
      'title': title,
    };
  }

factory Event.fromMap(Map<String, dynamic> map) {
  return Event(
    date: DateTime.fromMillisecondsSinceEpoch(map['date'] as int),
    title: map['title'] as String,
  );
}
```

But with Firestore we need to take care of the way Firestore stores DateTime. Therefore we need to implement the following:
```dart
Map<String, dynamic> toFirestoreMap() {
  return <String, dynamic>{
    'date': Timestamp.fromDate(date),
    'title': title,
  };
}

factory Event.fromFirestoreMap(Map<String, dynamic> firestoreMap) {
  return Event(
      date: (firestoreMap['date'] as Timestamp).toDate(),
      title: firestoreMap['title']);
}
```
Note that `Timestamp` is an object defined in the `cloud_firestore` package.


### Setting up your environment before the lecture

Each lecture is stored under a separate tag. In your computer do the following

    git clone <Repository Name>
    git pull
    git tag -l

This will list you all the tags in the repository such as

    Lecture4
    Lecture5
    Lecture6
    ...

In order to pull a particular tag to your computer

    git checkout tags/Lecture5_start -b Lecture5_study

### Cloning to Google IDX

1. Go to this link. [idx.dev](https://idx.google.com/import?url=https://github.com/mehmetartun/CSEN268-F24)
2. Name your project (default value is fine)
3. Click Flutter Project checkbox
4. Wait for the setup to continue
5. Open the terminal and pull requisite tag from the repo by
```zsh
git pull
git tag -l
git tags/<TagName> -b <NewLocalBranchName>
```



